version: 2.1

commands:
  build:
    steps:
      - checkout

      - run:
          command: npm version

      - run:
          command: npm ci

      - run:
          command: npm run lint

      - run:
          command: npm run type-check

      - run:
          name: Install mediainfo
          command: |
            apt-get update
            wget https://mediaarea.net/download/binary/libzen0/0.4.37/libzen0_0.4.37-1_amd64.Debian_8.0.deb
            dpkg -i libzen0_0.4.37-1_amd64.Debian_8.0.deb
            wget https://mediaarea.net/download/binary/libmediainfo0/18.08.1/libmediainfo0_18.08.1-1_amd64.Debian_8.0.deb
            apt install libmms0
            dpkg -i libmediainfo0_18.08.1-1_amd64.Debian_8.0.deb
            wget https://mediaarea.net/download/binary/mediainfo/18.08.1/mediainfo_18.08.1-1_amd64.Debian_8.0.deb
            dpkg -i mediainfo_18.08.1-1_amd64.Debian_8.0.deb

      - run:
          command: npm run test -- --ci --coverage --runInBand --reporters=default --reporters=jest-junit
          environment:
            JEST_JUNIT_OUTPUT: "reports/junit/results.xml"

      - store_test_results:
          path: reports/junit

      - store_artifacts:
          path: reports/junit

  upload-coverage:
    steps:
      - run:
          name: Upload coverage to Codacy
          command: cat ./coverage/lcov.info | ./node_modules/.bin/codacy-coverage

      - run:
          name: Upload coverage to Codecov
          command: bash <(curl -s https://codecov.io/bash)

  publish:
    steps:
      - run:
          command: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
      - run:
          command: npm publish


jobs:
  test-v8:
    docker:
      - image: node:8
    steps:
      - build

  test-v10:
    docker:
      - image: node:10
    steps:
      - build
      - upload-coverage

  test-v11:
    docker:
      - image: node:11
    steps:
      - build

  publish-v8:
    docker:
      - image: node:8
    steps:
      - build
      - publish

workflows:
  test-deploy:
    jobs:
      - test-v8:
          filters:
            tags:
              only: /^v.*/

      - test-v10:
          filters:
            tags:
              only: /^v.*/

      - test-v11:
          filters:
            tags:
              only: /^v.*/

      - publish-v8:
          requires:
            - test-v8
            - test-v10
            - test-v11
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
